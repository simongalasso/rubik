<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Rubik's</title>
    <style>
        body {
            margin: 0;
        }
        .fullcontainer {
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            position: fixed;
            display: block;
            opacity: 0.5;
            background-color: #fff;
            z-index: 99;
            text-align: center;
            visibility: hidden;
        }
        .maincontainer {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            flex-direction: column;
        }
        .container {
            display: flex;
            flex-direction: row;
        }
        .text {
            color: white;
        }
        .seq {
            margin-left: 10px;
        }
        .btn:hover {
            cursor: pointer;
        }
        .loader {
            position: absolute;
            z-index: 100;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 16px solid #f3f3f3; /* Light grey */
            border-top: 16px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 120px;
            height: 120px;
            opacity: 1;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
    </style>
</head>

<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r121/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.101.1/examples/js/controls/OrbitControls.js"></script>
    <script src="/js/rubiks-three.js" ></script>
    <div id="loader" class="fullcontainer">
        <div class="loader"></div>
    </div>
    <div class="maincontainer">
        <div class="container">
            <select id="speed" onchange="updateSpeed(this)">
                <option value="0.01">Speed 1</option>
                <option value="0.03">Speed 2</option>
                <option value="0.05" selected>Speed 3</option>
            </select>
        </div>
        <div class="container">
            <button class="btn" onclick="scramble()">Scramble</button>
            <button class="btn" onclick="resetCube()">Reset</button>
        </div>
        <div class="container">
            <button class="btn" onclick="applySequence('U')">U</button>
            <button class="btn" onclick="applySequence('R')">R</button>
            <button class="btn" onclick="applySequence('F')">F</button>
            <button class="btn" onclick="applySequence('D')">D</button>
            <button class="btn" onclick="applySequence('L')">L</button>
            <button class="btn" onclick="applySequence('B')">B</button>
        </div>
        <div class="container">
            <button class="btn" onclick="applySequence('U\'')">U'</button>
            <button class="btn" onclick="applySequence('R\'')">R'</button>
            <button class="btn" onclick="applySequence('F\'')">F'</button>
            <button class="btn" onclick="applySequence('D\'')">D'</button>
            <button class="btn" onclick="applySequence('L\'')">L'</button>
            <button class="btn" onclick="applySequence('B\'')">B'</button>
        </div>
        <div class="container">
            <input type="text" id="sequence-parser" name="sequence-parser">
            <button class="btn" onclick="parseSequence()">Set sequence</button>
        </div>
        <div class="container">
            <button class="btn" onclick="nextmove()">Launch</button>
            <button class="btn" onclick="clearSequence()">Clear queue</button>
        </div>
        <div class="container text">
            <p>Queue: </p>
            <p id="sequence" class="seq">No action</p>
        </div>
        <div class="container">
            <button class="btn" onclick="solve()">Solve!</button>
        </div>
    </div>
    <script>
        function httpGetAsync(theUrl, callback) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function () {
                if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
                    callback(xmlHttp.responseText);
            }
            xmlHttp.open("GET", theUrl, true);
            xmlHttp.send(null);
        }

        const scramble = () => {
            if (!moving) {
                httpGetAsync('/scramble', (res) => {
                    clearSequence();
                    applySequence(res);
                    nextmove();
                })
            } else {
                alert("Cube is moving!");
            }
        }

        const solve = () => {
            if (!moving) {
                clearSequence();
                var xmlHttp = new XMLHttpRequest();
                xmlHttp.onreadystatechange = function () {
                    if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                        document.getElementById('loader').style.visibility = "hidden";
                        obj = JSON.parse(xmlHttp.responseText);
                        applySequence(obj.solution);
                        nextmove();
                    }
                }
                xmlHttp.open("POST", "/solver", true);
                xmlHttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                xmlHttp.send(JSON.stringify({ "sequence": `${get_total_sequence().join(" ")}` }));
                document.getElementById('loader').style.visibility = "visible";
            } else {
                alert("Cube is moving!");
            }
        }

        const parseSequence = () => {
            const seq = document.getElementById("sequence-parser").value;
            applySequence(seq);
            document.getElementById("sequence-parser").value = "";
        }

        const updateSpeed = (element) => {
            var idx = element.selectedIndex;
            var val = element.options[idx].value;
            setSpeed(val);
        }
    </script>
</body>

</html>